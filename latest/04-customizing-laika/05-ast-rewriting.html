<!DOCTYPE html>
<html lang="en">
  
  <head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="generator" content="Typelevel Laika + Helium Theme" />
  <title>AST Rewriting</title>
  
  
  <meta name="description" content="Site and E-book Generator and Customizable Text Markup Transformer for sbt, Scala and Scala.js"/>
  
  
  
  <link rel="icon" sizes="32x32" type="image/png" href="../../img/site/laika-favicon.png"/>
  
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700">
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Fira+Mono:500">
  
  <link rel="stylesheet" type="text/css" href="../helium/site/icofont.min.css" />
    <link rel="stylesheet" type="text/css" href="../helium/site/laika-helium.css" />
    <link rel="stylesheet" type="text/css" href="../css/manual.css" />
    <link rel="stylesheet" type="text/css" href="../search/search.css" />
  <script src="../helium/site/laika-helium.js"></script>
    <script src="../helium/site/laika-versions.js"></script>
    <script src="../search/protosearch.js"></script>
    <script src="../search/searchBar.js"></script>
  <script>initVersions("../../", "/04-customizing-laika/05-ast-rewriting.html", "latest", "https://typelevel.org/Laika/");</script>
  
  <script> /* for avoiding page load transitions */ </script>
</head>

  <body>

    <header id="top-bar" class="light-default dark-default">

  <div class="row">
    <a id="nav-icon">
      <i class="icofont-laika navigationMenu" title="Navigation">&#xefa2;</i>
    </a>

    <div class="menu-container version-menu">
      <a class="text-link menu-toggle" href="#">Version 1.x</a>
      <nav class="menu-content">
        <ul class="nav-list">
          <li class="level1 nav-leaf"><a href="../../olderVersions/">Older Versions</a></li>
        </ul>
      </nav>
    </div>
  </div>

  <a class="icon-link glyph-link" href="../../"><i class="icofont-laika home" title="Home">&#xef47;</i></a>

  <div class="row search-row">
    <input id="search-top-bar" class="input" type="text" placeholder="Search">
  </div>
  <div id="search-modal" class="search-modal">
    <div class="search-modal-content">
      <span class="search-close">&times;</span>
      <input id="search-modal-input" class="input" type="text">
      <div id="search-modal-content-body"></div>
    </div>
  </div>

  <div class="row links">
    
    <a class="icon-link svg-link" href="https://github.com/typelevel/Laika"><span class="github" title="Source Code"><svg class="svg-icon" width="100%" height="100%" viewBox="0 0 100 100" version="1.1" xmlns="http://www.w3.org/2000/svg" xml:space="preserve" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
  <g class="svg-shape">
    <path d="M49.995,1c-27.609,-0 -49.995,22.386 -49.995,50.002c-0,22.09 14.325,40.83 34.194,47.444c2.501,0.458 3.413,-1.086 3.413,-2.412c0,-1.185 -0.043,-4.331 -0.067,-8.503c-13.908,3.021 -16.843,-6.704 -16.843,-6.704c-2.274,-5.773 -5.552,-7.311 -5.552,-7.311c-4.54,-3.103 0.344,-3.042 0.344,-3.042c5.018,0.356 7.658,5.154 7.658,5.154c4.46,7.64 11.704,5.433 14.552,4.156c0.454,-3.232 1.744,-5.436 3.174,-6.685c-11.102,-1.262 -22.775,-5.553 -22.775,-24.713c-0,-5.457 1.949,-9.92 5.147,-13.416c-0.516,-1.265 -2.231,-6.348 0.488,-13.233c0,0 4.199,-1.344 13.751,5.126c3.988,-1.108 8.266,-1.663 12.518,-1.682c4.245,0.019 8.523,0.574 12.517,1.682c9.546,-6.47 13.736,-5.126 13.736,-5.126c2.728,6.885 1.013,11.968 0.497,13.233c3.204,3.496 5.141,7.959 5.141,13.416c0,19.209 -11.691,23.436 -22.83,24.673c1.795,1.544 3.394,4.595 3.394,9.26c0,6.682 -0.061,12.076 -0.061,13.715c0,1.338 0.899,2.894 3.438,2.406c19.853,-6.627 34.166,-25.354 34.166,-47.438c-0,-27.616 -22.389,-50.002 -50.005,-50.002"/>
  </g>
</svg></span></a>
    
    <a class="icon-link svg-link" href="https://javadoc.io/doc/org.typelevel/laika-docs_2.12/latest/laika/index.html"><span class="api" title="API"><svg class="svg-icon" width="100%" height="100%" viewBox="0 0 100 100" version="1.1" xmlns="http://www.w3.org/2000/svg" xml:space="preserve" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
  <g class="svg-shape">
    <path d="M75,47.5c13.246,0 24,10.754 24,24c0,13.246 -10.754,24 -24,24c-13.246,0 -24,-10.754 -24,-24c0,-13.246 10.754,-24 24,-24Zm-50,-0c13.246,-0 24,10.754 24,24c0,13.246 -10.754,24 -24,24c-13.246,-0 -24,-10.754 -24,-24c0,-13.246 10.754,-24 24,-24Zm2.705,16.735l7.239,0l0.622,-4.904l-21.833,0l-0,4.904l7.589,0l0,22.067l6.383,0l-0,-22.067Zm58.076,7.265c-0,-8.757 -3.698,-14.166 -10.781,-14.166c-7.083,-0 -10.781,5.604 -10.781,14.166c0,8.757 3.698,14.166 10.781,14.166c7.083,0 10.781,-5.604 10.781,-14.166Zm-6.539,0c0,6.538 -1.128,9.496 -4.242,9.496c-2.997,0 -4.242,-2.88 -4.242,-9.496c-0,-6.616 1.206,-9.496 4.242,-9.496c3.036,-0 4.242,2.88 4.242,9.496Zm-29.242,-67c13.246,0 24,10.754 24,24c0,13.246 -10.754,24 -24,24c-13.246,0 -24,-10.754 -24,-24c0,-13.246 10.754,-24 24,-24Zm0.512,9.834c-7.122,-0 -12.609,5.098 -12.609,14.127c-0,9.263 5.215,14.205 12.532,14.205c4.164,0 7.083,-1.634 9.068,-3.658l-2.88,-3.697c-1.518,1.206 -3.153,2.413 -5.838,2.413c-3.697,-0 -6.266,-2.763 -6.266,-9.263c-0,-6.616 2.724,-9.379 6.149,-9.379c2.102,-0 3.892,0.778 5.371,1.984l3.113,-3.775c-2.257,-1.868 -4.748,-2.957 -8.64,-2.957Z"/>
  </g>
</svg></span></a>
    
    <a class="icon-link glyph-link" href="../downloads.html"><i class="icofont-laika download" title="Download">&#xef08;</i></a>
    
    <a class="icon-link glyph-link" href="https://discord.gg/XF3CXcMzqD"><i class="icofont-laika chat" title="Chat">&#xeed5;</i></a>
    
  </div>

</header>

    
    <nav id="sidebar">

  <div class="row">
    
    <a class="icon-link svg-link" href="https://github.com/typelevel/Laika"><span class="github" title="Source Code"><svg class="svg-icon" width="100%" height="100%" viewBox="0 0 100 100" version="1.1" xmlns="http://www.w3.org/2000/svg" xml:space="preserve" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
  <g class="svg-shape">
    <path d="M49.995,1c-27.609,-0 -49.995,22.386 -49.995,50.002c-0,22.09 14.325,40.83 34.194,47.444c2.501,0.458 3.413,-1.086 3.413,-2.412c0,-1.185 -0.043,-4.331 -0.067,-8.503c-13.908,3.021 -16.843,-6.704 -16.843,-6.704c-2.274,-5.773 -5.552,-7.311 -5.552,-7.311c-4.54,-3.103 0.344,-3.042 0.344,-3.042c5.018,0.356 7.658,5.154 7.658,5.154c4.46,7.64 11.704,5.433 14.552,4.156c0.454,-3.232 1.744,-5.436 3.174,-6.685c-11.102,-1.262 -22.775,-5.553 -22.775,-24.713c-0,-5.457 1.949,-9.92 5.147,-13.416c-0.516,-1.265 -2.231,-6.348 0.488,-13.233c0,0 4.199,-1.344 13.751,5.126c3.988,-1.108 8.266,-1.663 12.518,-1.682c4.245,0.019 8.523,0.574 12.517,1.682c9.546,-6.47 13.736,-5.126 13.736,-5.126c2.728,6.885 1.013,11.968 0.497,13.233c3.204,3.496 5.141,7.959 5.141,13.416c0,19.209 -11.691,23.436 -22.83,24.673c1.795,1.544 3.394,4.595 3.394,9.26c0,6.682 -0.061,12.076 -0.061,13.715c0,1.338 0.899,2.894 3.438,2.406c19.853,-6.627 34.166,-25.354 34.166,-47.438c-0,-27.616 -22.389,-50.002 -50.005,-50.002"/>
  </g>
</svg></span></a>
    
    <a class="icon-link svg-link" href="https://javadoc.io/doc/org.typelevel/laika-docs_2.12/latest/laika/index.html"><span class="api" title="API"><svg class="svg-icon" width="100%" height="100%" viewBox="0 0 100 100" version="1.1" xmlns="http://www.w3.org/2000/svg" xml:space="preserve" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
  <g class="svg-shape">
    <path d="M75,47.5c13.246,0 24,10.754 24,24c0,13.246 -10.754,24 -24,24c-13.246,0 -24,-10.754 -24,-24c0,-13.246 10.754,-24 24,-24Zm-50,-0c13.246,-0 24,10.754 24,24c0,13.246 -10.754,24 -24,24c-13.246,-0 -24,-10.754 -24,-24c0,-13.246 10.754,-24 24,-24Zm2.705,16.735l7.239,0l0.622,-4.904l-21.833,0l-0,4.904l7.589,0l0,22.067l6.383,0l-0,-22.067Zm58.076,7.265c-0,-8.757 -3.698,-14.166 -10.781,-14.166c-7.083,-0 -10.781,5.604 -10.781,14.166c0,8.757 3.698,14.166 10.781,14.166c7.083,0 10.781,-5.604 10.781,-14.166Zm-6.539,0c0,6.538 -1.128,9.496 -4.242,9.496c-2.997,0 -4.242,-2.88 -4.242,-9.496c-0,-6.616 1.206,-9.496 4.242,-9.496c3.036,-0 4.242,2.88 4.242,9.496Zm-29.242,-67c13.246,0 24,10.754 24,24c0,13.246 -10.754,24 -24,24c-13.246,0 -24,-10.754 -24,-24c0,-13.246 10.754,-24 24,-24Zm0.512,9.834c-7.122,-0 -12.609,5.098 -12.609,14.127c-0,9.263 5.215,14.205 12.532,14.205c4.164,0 7.083,-1.634 9.068,-3.658l-2.88,-3.697c-1.518,1.206 -3.153,2.413 -5.838,2.413c-3.697,-0 -6.266,-2.763 -6.266,-9.263c-0,-6.616 2.724,-9.379 6.149,-9.379c2.102,-0 3.892,0.778 5.371,1.984l3.113,-3.775c-2.257,-1.868 -4.748,-2.957 -8.64,-2.957Z"/>
  </g>
</svg></span></a>
    
    <a class="icon-link glyph-link" href="../downloads.html"><i class="icofont-laika download" title="Download">&#xef08;</i></a>
    
    <a class="icon-link glyph-link" href="https://discord.gg/XF3CXcMzqD"><i class="icofont-laika chat" title="Chat">&#xeed5;</i></a>
    
  </div>

  <ul class="nav-list">
    <li class="level1 nav-leaf"><a href="../table-of-content.html">Table of Content</a></li>
    <li class="level1 nav-leaf"><a href="../downloads.html">Documentation Downloads</a></li>
    <li class="level1 nav-header">About Laika</li>
    <li class="level2 nav-leaf"><a href="../01-about-laika/01-features.html">Features</a></li>
    <li class="level2 nav-leaf"><a href="../01-about-laika/02-design-goals.html">Design Goals</a></li>
    <li class="level1 nav-header">Running Laika</li>
    <li class="level2 nav-leaf"><a href="../02-running-laika/01-sbt-plugin.html">sbt Plugin</a></li>
    <li class="level2 nav-leaf"><a href="../02-running-laika/02-library-api.html">Library API</a></li>
    <li class="level2 nav-leaf"><a href="../02-running-laika/03-configuration.html">Configuration</a></li>
    <li class="level1 nav-header">Preparing Content</li>
    <li class="level2 nav-leaf"><a href="../03-preparing-content/01-directory-structure.html">Directory Structure</a></li>
    <li class="level2 nav-leaf"><a href="../03-preparing-content/02-navigation.html">Navigation</a></li>
    <li class="level2 nav-leaf"><a href="../03-preparing-content/03-theme-settings.html">Theme Settings</a></li>
    <li class="level2 nav-leaf"><a href="../03-preparing-content/04-ebooks.html">E-Books (EPUB &amp; PDF)</a></li>
    <li class="level2 nav-leaf"><a href="../03-preparing-content/05-syntax-highlighting.html">Syntax Highlighting</a></li>
    <li class="level1 nav-header">Customizing Laika</li>
    <li class="level2 nav-leaf"><a href="01-overview.html">Customizing Laika - Overview</a></li>
    <li class="level2 nav-leaf"><a href="03-creating-templates.html">Creating Templates</a></li>
    <li class="level2 nav-leaf"><a href="04-document-ast.html">The Document AST</a></li>
    <li class="level2 active nav-leaf"><a href="#">AST Rewriting</a></li>
    <li class="level2 nav-leaf"><a href="06-overriding-renderers.html">Overriding Renderers</a></li>
    <li class="level1 nav-header">Extending Laika</li>
    <li class="level2 nav-leaf"><a href="../05-extending-laika/01-overview.html">Extending Laika - Overview</a></li>
    <li class="level2 nav-leaf"><a href="../05-extending-laika/02-creating-themes.html">Creating Themes</a></li>
    <li class="level2 nav-leaf"><a href="../05-extending-laika/03-implementing-directives.html">Implementing Directives</a></li>
    <li class="level2 nav-leaf"><a href="../05-extending-laika/04-writing-parser-extensions.html">Writing Parser Extensions</a></li>
    <li class="level2 nav-leaf"><a href="../05-extending-laika/06-adding-syntax-highlighters.html">Adding Syntax Highlighters</a></li>
    <li class="level2 nav-leaf"><a href="../05-extending-laika/07-new-markup-output-formats.html">New Markup or Output Formats</a></li>
    <li class="level1 nav-header">Sub-Modules</li>
    <li class="level2 nav-leaf"><a href="../06-sub-modules/02-laikas-parser-combinators.html">Laika&#39;s Parser Combinators</a></li>
    <li class="level2 nav-leaf"><a href="../06-sub-modules/03-laikas-hocon-api.html">Laika&#39;s HOCON API</a></li>
    <li class="level1 nav-header">Reference</li>
    <li class="level2 nav-leaf"><a href="../07-reference/01-standard-directives.html">Standard Directives</a></li>
    <li class="level2 nav-leaf"><a href="../07-reference/02-substitution-variables.html">Substitution Variables</a></li>
    <li class="level2 nav-leaf"><a href="../07-reference/03-spec-compliance.html">Spec Compliance</a></li>
    <li class="level2 nav-leaf"><a href="../07-reference/07-migration-guide.html">Migration Guide</a></li>
  </ul>

</nav>

    <div id="container">

      
<nav id="page-nav">
  <p class="header"><a href="#">AST Rewriting</a></p>

  <ul class="nav-list">
    <li class="level1 nav-leaf"><a href="#how-rewrite-rules-work">How Rewrite Rules Work</a></li>
    <li class="level1 nav-node"><a href="#applying-a-rewrite-rule">Applying a Rewrite Rule</a></li>
    <li class="level2 nav-leaf"><a href="#using-the-sbt-plugin">Using the sbt Plugin</a></li>
    <li class="level2 nav-leaf"><a href="#using-the-transformer-api">Using the Transformer API</a></li>
    <li class="level2 nav-leaf"><a href="#working-with-the-tree-model">Working with the Tree Model</a></li>
    <li class="level1 nav-leaf"><a href="#effectful-ast-transformations">Effectful AST Transformations</a></li>
  </ul>

  <p class="footer"><a href="https://github.com/typelevel/Laika/tree/main/docs/src/04-customizing-laika/05-ast-rewriting.md"><i class="icofont-laika edit" title="Edit">&#xef10;</i>Source for this page</a></p>
</nav>


      <main class="content">

        <h1 id="ast-rewriting" class="title">AST Rewriting</h1>
        <p>The document tree in a Laika transformation is a generic representation of the document 
        that does not contain any specific semantic or technical coupling to a concrete input or output format. 
        This allows to add custom processing logic only operating on the document structure itself, 
        so it can be used with all supported input and output formats unchanged.</p>
        <p>Rewriting a tree means traversing it and replacing or removing some of its nodes.
        A tree model is immutable, so rewriting always creates a new tree, 
        while reusing unmodified branches for efficiency.</p>
        <p>Several of Laika&#39;s built-in features are implemented as rewrite rules internally,
        like the mechanism for resolving internal references or footnote auto-numbering.
        But it is also designed to be a hook for processing on the application level.</p>
        
        <h2 id="how-rewrite-rules-work" class="section"><a class="anchor-link left" href="#how-rewrite-rules-work"><i class="icofont-laika link">&#xef71;</i></a>How Rewrite Rules Work</h2>
        <p>A rewrite rule has the type <code>PartialFunction[T, RewriteAction[T]]</code>. 
        Laika offers a type alias <code>RewriteRule[T]</code> for convenience.</p>
        <p>The rules are as follows:</p>
        <ul>
          <li>
            <p>If the function is not defined for a particular element or it returns <code>Retain</code> the old element is kept in the tree.</p>
          </li>
          <li>
            <p>If the function returns <code>Replace(newElement)</code> this element is used in place of the old one.</p>
          </li>
          <li>
            <p>If the function returns <code>Remove</code> the old element is removed from the tree.</p>
          </li>
          <li>
            <p>Processing happens depth-first (bottom-up), 
            so all nodes getting passed to this function already had their children getting processed.</p>
          </li>
          <li>
            <p>The tree is immutable, therefore new instances are returned when rewriting.</p>
          </li>
        </ul>
        <p>The following sections show the three ways to apply such a rule.</p>
        
        <h2 id="applying-a-rewrite-rule" class="section"><a class="anchor-link left" href="#applying-a-rewrite-rule"><i class="icofont-laika link">&#xef71;</i></a>Applying a Rewrite Rule</h2>
        <p>The mechanism is slightly different, depending on whether you are using the sbt
        plugin or Laika embedded in an application. In the latter case you have two
        choices, one for hooking into a full transformation, the other for operating
        on nodes obtained by a separate parse operation. All three options are described below.</p>
        
        <h3 id="using-the-sbt-plugin" class="section"><a class="anchor-link left" href="#using-the-sbt-plugin"><i class="icofont-laika link">&#xef71;</i></a>Using the sbt Plugin</h3>
        <p>The following example of an sbt build file shows how to turn each <code>Emphasized</code> node
        into a <code>Strong</code> node while processing everything else with default rules:</p>
        <pre class="keep-together pdf epub"><code class="nohighlight"><span class="keyword">import</span><span> </span><span class="identifier">laika</span><span>.</span><span class="identifier">ast</span><span>.</span><span class="identifier">_</span><span>

</span><span class="identifier">laikaExtensions</span><span> += </span><span class="identifier">laikaSpanRewriteRule</span><span> { 
  </span><span class="keyword">case</span><span> </span><span class="type-name">Emphasized</span><span>(</span><span class="identifier">content</span><span>, </span><span class="identifier">opts</span><span>) =&gt; </span><span class="type-name">RewriteAction</span><span>.</span><span class="type-name">Replace</span><span>(</span><span class="type-name">Strong</span><span>(</span><span class="identifier">content</span><span>, </span><span class="identifier">opts</span><span>))
}</span></code></pre>
        
        <h3 id="using-the-transformer-api" class="section"><a class="anchor-link left" href="#using-the-transformer-api"><i class="icofont-laika link">&#xef71;</i></a>Using the Transformer API</h3>
        <p>When using the library API and all you want to do is to perform a full transformation 
        from some input text to some output format, 
        the Transformer API offers a hook to do this in one go, as a step in the transformation process.</p>
        <p>Again we replace all <code>Emphasized</code> nodes with <code>Strong</code> nodes:</p>
        <pre class="keep-together pdf epub"><code class="nohighlight"><span class="keyword">import</span><span> </span><span class="identifier">laika</span><span>.</span><span class="identifier">api</span><span>.</span><span class="identifier">_</span><span>
</span><span class="keyword">import</span><span> </span><span class="identifier">laika</span><span>.</span><span class="identifier">ast</span><span>.</span><span class="identifier">_</span><span>
</span><span class="keyword">import</span><span> </span><span class="identifier">laika</span><span>.</span><span class="identifier">format</span><span>.</span><span class="identifier">_</span><span>

</span><span class="keyword">val</span><span> </span><span class="identifier">transformer</span><span> = </span><span class="type-name">Transformer</span><span>
  .</span><span class="identifier">from</span><span>(</span><span class="type-name">ReStructuredText</span><span>)
  .</span><span class="identifier">to</span><span>(</span><span class="type-name">HTML</span><span>)
  .</span><span class="identifier">usingSpanRule</span><span> {
    </span><span class="keyword">case</span><span> </span><span class="type-name">Emphasized</span><span>(</span><span class="identifier">content</span><span>, </span><span class="identifier">opts</span><span>) =&gt; </span><span class="type-name">RewriteAction</span><span>.</span><span class="type-name">Replace</span><span>(</span><span class="type-name">Strong</span><span>(</span><span class="identifier">content</span><span>, </span><span class="identifier">opts</span><span>))
  }.</span><span class="identifier">build</span></code></pre>
        
        <h3 id="working-with-the-tree-model" class="section"><a class="anchor-link left" href="#working-with-the-tree-model"><i class="icofont-laika link">&#xef71;</i></a>Working with the Tree Model</h3>
        <p>The final option is to use the <code>rewrite</code> method on individual documents or AST nodes.</p>
        <p>The types <code>DocumentTree</code> and <code>Document</code> come with a <code>rewrite</code> method as well as most of the node types 
        that can occur within a document (all nodes that mix in <code>RewritableContainer</code>).</p>
        <p>Obtaining <code>Document</code> instances is usually achieved by splitting the parsing and rendering operations
        instead of using a full transformer. This is described in detail in <a href="../02-running-laika/02-library-api.html#separate-parsing-and-rendering">Separate Parsing and Rendering</a>.</p>
        <p>Once again we are turning all <code>Emphasized</code> nodes in the text to <code>Strong</code> nodes for our example:</p>
        <pre class="keep-together pdf epub"><code class="nohighlight"><span class="keyword">import</span><span> </span><span class="identifier">laika</span><span>.</span><span class="identifier">ast</span><span>.</span><span class="identifier">_</span><span>

</span><span class="keyword">def</span><span> </span><span class="declaration-name">doc</span><span>: </span><span class="type-name">Document</span><span> = ??? </span><span class="comment">// obtained through the Parser API
</span><span>
</span><span class="keyword">val</span><span> </span><span class="identifier">newDoc</span><span> = </span><span class="identifier">doc</span><span>.</span><span class="identifier">rewrite</span><span>(</span><span class="type-name">RewriteRules</span><span>.</span><span class="identifier">forSpans</span><span> {
  </span><span class="keyword">case</span><span> </span><span class="type-name">Emphasized</span><span>(</span><span class="identifier">content</span><span>, </span><span class="identifier">opts</span><span>) =&gt; </span><span class="type-name">RewriteAction</span><span>.</span><span class="type-name">Replace</span><span>(</span><span class="type-name">Strong</span><span>(</span><span class="identifier">content</span><span>, </span><span class="identifier">opts</span><span>))
})</span></code></pre>
        <p>For a slightly more advanced example, let&#39;s assume you only want to replace <code>Emphasized</code> nodes inside headers. 
        To accomplish this you need to nest a rewrite operation inside another one:</p>
        <pre class="keep-together pdf epub"><code class="nohighlight"><span class="keyword">import</span><span> </span><span class="identifier">laika</span><span>.</span><span class="identifier">ast</span><span>.</span><span class="identifier">_</span><span>

</span><span class="keyword">def</span><span> </span><span class="declaration-name">doc</span><span>: </span><span class="type-name">Document</span><span> = ??? </span><span class="comment">// obtained through the Parser API
</span><span>
</span><span class="keyword">val</span><span> </span><span class="identifier">newDoc</span><span> = </span><span class="identifier">doc</span><span>.</span><span class="identifier">rewrite</span><span>(</span><span class="type-name">RewriteRules</span><span>.</span><span class="identifier">forBlocks</span><span> {
  </span><span class="keyword">case</span><span> </span><span class="identifier">h</span><span>: </span><span class="type-name">Header</span><span> =&gt; </span><span class="type-name">RewriteAction</span><span>.</span><span class="type-name">Replace</span><span>(</span><span class="identifier">h</span><span>.</span><span class="identifier">rewriteSpans</span><span> {
    </span><span class="keyword">case</span><span> </span><span class="type-name">Emphasized</span><span>(</span><span class="identifier">content</span><span>, </span><span class="identifier">opts</span><span>) =&gt; </span><span class="type-name">RewriteAction</span><span>.</span><span class="type-name">Replace</span><span>(</span><span class="type-name">Strong</span><span>(</span><span class="identifier">content</span><span>, </span><span class="identifier">opts</span><span>))
  })
})</span></code></pre>
        
        <h2 id="effectful-ast-transformations" class="section"><a class="anchor-link left" href="#effectful-ast-transformations"><i class="icofont-laika link">&#xef71;</i></a>Effectful AST Transformations</h2>
        <p>The rewrite rules shown in this chapter so far were all applied to individual nodes within parsed documents,
        and had to be pure functions without any side effects.</p>
        <p>There is a related functionality called <code>TreeProcessor</code>, which is part of the <code>laika-io</code> module 
        and the sbt plugin and offers additional options:</p>
        <ul>
          <li>Adding, removing or replacing entire documents from the AST.</li>
          <li>Applying rewrite rules to specific documents only.</li>
          <li>Defining rules which perform side effects.</li>
        </ul>
        <p>Our example shows how to add a document to the virtual tree for PDF documents only:</p>
        <div class="tab-container" data-tab-group="config">
          <ul class="tab-group">
            <li class="tab active" data-choice-name="sbt"><a href="#">sbt Plugin</a></li>
            <li class="tab" data-choice-name="library"><a href="#">Library API</a></li>
          </ul>
          <div class="tab-content active" data-choice-name="sbt">
            <pre class="keep-together pdf epub"><code class="nohighlight"><span class="keyword">import</span><span> </span><span class="identifier">cats</span><span>.</span><span class="identifier">effect</span><span>.</span><span class="type-name">IO</span><span>
</span><span class="keyword">import</span><span> </span><span class="identifier">laika</span><span>.</span><span class="identifier">ast</span><span>.</span><span class="identifier">_</span><span>
</span><span class="keyword">import</span><span> </span><span class="identifier">laika</span><span>.</span><span class="identifier">theme</span><span>.</span><span class="type-name">TreeProcessorBuilder</span><span>

</span><span class="keyword">def</span><span> </span><span class="declaration-name">intro</span><span>: </span><span class="type-name">Document</span><span> = ??? </span><span class="comment">// e.g. created in-memory
</span><span>
</span><span class="keyword">val</span><span> </span><span class="identifier">processor</span><span> = </span><span class="type-name">TreeProcessorBuilder</span><span>[</span><span class="type-name">IO</span><span>].</span><span class="identifier">mapTree</span><span> { </span><span class="identifier">tree</span><span> =&gt;
  </span><span class="identifier">tree</span><span>.</span><span class="identifier">modifyTree</span><span>(</span><span class="identifier">_</span><span>.</span><span class="identifier">prependContent</span><span>(</span><span class="identifier">intro</span><span>))
}

</span><span class="identifier">laikaTreeProcessors</span><span> += </span><span class="type-name">LaikaTreeProcessor</span><span>(</span><span class="identifier">processor</span><span>, </span><span class="type-name">OutputContext</span><span>(</span><span class="type-name">PDF</span><span>))</span></code></pre>
          </div>
          <div class="tab-content" data-choice-name="library">
            <pre><code class="nohighlight"><span class="keyword">import</span><span> </span><span class="identifier">cats</span><span>.</span><span class="identifier">effect</span><span>.</span><span class="type-name">IO</span><span>
</span><span class="keyword">import</span><span> </span><span class="identifier">laika</span><span>.</span><span class="identifier">api</span><span>.</span><span class="identifier">_</span><span>
</span><span class="keyword">import</span><span> </span><span class="identifier">laika</span><span>.</span><span class="identifier">format</span><span>.</span><span class="identifier">_</span><span>
</span><span class="keyword">import</span><span> </span><span class="identifier">laika</span><span>.</span><span class="identifier">io</span><span>.</span><span class="identifier">syntax</span><span>.</span><span class="identifier">_</span><span>

</span><span class="keyword">def</span><span> </span><span class="declaration-name">intro</span><span>: </span><span class="type-name">Document</span><span> = ??? </span><span class="comment">// e.g. created in-memory
</span><span>
</span><span class="keyword">val</span><span> </span><span class="identifier">transformer</span><span> = </span><span class="type-name">Transformer</span><span>
  .</span><span class="identifier">from</span><span>(</span><span class="type-name">Markdown</span><span>)
  .</span><span class="identifier">to</span><span>(</span><span class="type-name">PDF</span><span>)
  .</span><span class="identifier">parallel</span><span>[</span><span class="type-name">IO</span><span>]
  .</span><span class="identifier">mapTree</span><span>(</span><span class="identifier">_</span><span>.</span><span class="identifier">modifyTree</span><span>(</span><span class="identifier">_</span><span>.</span><span class="identifier">prependContent</span><span>(</span><span class="identifier">intro</span><span>)))
  .</span><span class="identifier">build</span></code></pre>
          </div>
        </div>

        
<hr class="footer-rule"/>
<footer>
  Site generated by <a href="https://typelevel.org/Laika/">Laika</a> with the Helium theme.
</footer>


      </main>

    </div>

  </body>

</html>